# Caddyfile for Portfolio Monorepo
# This file uses placeholders that will be replaced by deploy.sh
# Placeholders: {{DOMAIN}}, {{EMAIL}}
#
# For local development:
# - Replace {{DOMAIN}} with localhost or a local domain (e.g., local.portfolio.test)
# - Replace {{EMAIL}} with your email address
# - Or use direct service ports: http://localhost:3000, http://localhost:8080, etc.

{
    # Global options
    email {{EMAIL}}
    auto_https on
}

# Main portfolio UI
{{DOMAIN}} {
    reverse_proxy portfolio:3000
    
    # Health check endpoint
    handle /health {
        reverse_proxy portfolio:3000
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# API endpoints with subdomains
api.{{DOMAIN}} {
    # Route to different services based on path
    handle /outbox/* {
        reverse_proxy outbox-api:8080
    }
    
    handle /flags/* {
        reverse_proxy feature-flags-api:4000
    }
    
    handle /observability/* {
        reverse_proxy observability-api:8081
    }
    
    # Default to outbox-api for root API calls
    handle {
        reverse_proxy outbox-api:8080
    }
    
    log {
        output file /var/log/caddy/api.log
        format json
    }
}

# Direct service access (for development/admin)
outbox.{{DOMAIN}} {
    reverse_proxy outbox-api:8080
}

feature-flags.{{DOMAIN}} {
    reverse_proxy feature-flags-api:4000
}

metrics.{{DOMAIN}} {
    reverse_proxy observability-api:8081
}

# Redirect HTTP to HTTPS
http://{{DOMAIN}} {
    redir https://{{DOMAIN}}{uri} permanent
}

http://api.{{DOMAIN}} {
    redir https://api.{{DOMAIN}}{uri} permanent
}
